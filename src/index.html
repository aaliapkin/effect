<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- <link rel="icon" href="%PUBLIC_URL%/favicon.ico" /> -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mandelbruh</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&display=swap" rel="stylesheet">
</head>

<body>
  <noscript>You need to enable JavaScript to view this site.</noscript>

  <script id="vertexShader" type="x-shader/x-vertex">#version 300 es
    precision highp float;
    layout(location = 0) in vec3 aPos;

    out vec2 uv;

    uniform mat4 u_MVP;

    void main() {
      gl_Position = vec4(aPos, 1.0);
      vec4 uv_out =  inverse(u_MVP) * gl_Position;
      uv = vec2(uv_out.x, uv_out.y);
    }
    
  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">#version 300 es
    
    precision highp float;
    #define MAX_ITERATIONS 255.0
    #define S(a, b, t) smoothstep(a, b, t)
    
    out vec4 FragColor;
    in vec2 uv;
    
    uniform vec4 u_bounds;
    uniform float u_time;
    uniform float u_Size;
    
    float map(float value, float min1, float max1, float min2, float max2) {
        return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
    }

    float N21(vec2 p) {
      p = fract(p * vec2(123.34f, 345.45f));      
      p += dot(p, p + 34.345f);
      return fract(p.x * p.y);      
    }
    
    void main()
    {
      FragColor = vec4(0.0f, 0.0f, 0.0f, 0.0f);
      float t = mod(u_time, 72000.0f);

      vec2 asp = vec2(2.0f, 1.0f); // y: 2, x: 1
      vec2 uv1 = uv * u_Size * asp;
      uv1.y += t * .25f;
      vec2 gv = fract(uv1) - .5f;
      vec2 id = floor(uv1);

      float n = N21(id);
      t += n * 6.2831;
      
      float w = uv.y * 10.0f;
      float x = (n - 0.5f) * .8f;
      x += (.4f - abs(x)) * sin(3.0f * w) * pow(sin(w), 6.0f) * .45f;
      float y = -sin(t + sin(t + sin(t) * .5f)) * .45f;
      y -= (gv.x - x) * (gv.x - x);

      vec2 dropPos = (gv - vec2(x, y)) / asp;
      float drop = S(.05f, .03f, length(dropPos));

      vec2 trailPos = (gv - vec2(x, t * .25f)) / asp;
      trailPos.y = (fract(trailPos.y * 8.0f) - 0.5f) / 8.0f;
      float trail = S(.03f, .01f, length(trailPos));
      float fogTrail = S(-.05f, .05f, dropPos.y);
      fogTrail *= S(.5f, y, gv.y);
      trail *= fogTrail;
      fogTrail *= S(0.05f, 0.04f, abs(dropPos.x));


      FragColor += fogTrail * 0.5f;
      FragColor += trail;
      FragColor += drop;
      // if(gv.x > 0.48f || gv.y > 0.49f) {
      //   FragColor = vec4(1.0f, 0.0f, 0.0f, 1.0f);
      // } 
      // FragColor += N21(id);
    }

  </script>

  <script src="./script.js"></script>

</body>

</html>